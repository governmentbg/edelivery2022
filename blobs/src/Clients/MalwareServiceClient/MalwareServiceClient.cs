using System;
using System.IO;
using System.Net;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http.Extensions;

namespace ED.Blobs
{
    public class MalwareServiceClient
    {
        public const string GeneralPurposeHttpClientName = "MalwareServiceClient_GeneralPurposeHttpClientName";
        public const string SubmitHttpClientName = "MalwareServiceClient_SubmitHttpClientName";

        // if the response is larger than 1MB we'd better throw an Exception
        private const long MaxResponseBufferSizeInBytes = 1024 * 1024;

        private HttpClient generalPurposeHttpClient;
        private HttpClient submitHttpClient;

        public MalwareServiceClient(IHttpClientFactory httpClientFactory)
        {
            this.generalPurposeHttpClient =
                httpClientFactory.CreateClient(GeneralPurposeHttpClientName);
            this.submitHttpClient =
                httpClientFactory.CreateClient(SubmitHttpClientName);
        }

        /// <summary>Submits a file for evaluation.</summary>
        /// <param name="fileStream">The data stream of the file to evaluate</param>
        /// <param name="fileName">The filename of the file to evaluate</param>
        /// <param name="correlationID">The correlation ID</param>
        /// <returns>The ID of the evaluation</returns>
        /// <exception cref="MalwareServiceClientException">
        /// A server side error occurred.
        /// </exception>
        /// <param name="ct">Cancellation token</param>
        public async Task<string> SubmitAsync(
            Stream fileStream,
            string fileName,
            string? correlationID,
            CancellationToken ct)
        {
            var query = new QueryBuilder();
            if (!string.IsNullOrEmpty(correlationID))
            {
                query.Add("correlationID", correlationID);
            }

            using var multipartFormDataContent = new MultipartFormDataContent();
            using var streamContent = new StreamContent(fileStream);
            multipartFormDataContent.Add(streamContent, "file", fileName);

            HttpResponseMessage resp;
            try
            {
                resp = await this.submitHttpClient.PostAsync(
                    "/eval" + query.ToString(),
                    multipartFormDataContent,
                    ct);

                // buffer the content so that we can read it multiple times if necessary
                // and throw an exception if its larger than expected
                await resp.Content.LoadIntoBufferAsync(MaxResponseBufferSizeInBytes);
            }
            catch (HttpRequestException ex)
            {
                throw new MalwareServiceClientException(
                    "MalwareService request failed.",
                    0,
                    string.Empty,
                    ex);
            }

            if (resp.IsSuccessStatusCode)
            {
                var malwareScanId =
                    await resp.Content.ReadFromJsonAsync<string>(null, ct);

                if (malwareScanId == null)
                {
                    // get the content as Stream and rewind it
                    Stream stream = await resp.Content.ReadAsStreamAsync(ct);
                    stream.Seek(0, SeekOrigin.Begin);

                    string response = await resp.Content.ReadAsStringAsync(ct);

                    throw new MalwareServiceClientException(
                        "MalwareScanId is null.",
                        (int)resp.StatusCode,
                        response,
                        null);
                }

                return malwareScanId;
            }
            else
            {
                string response = await resp.Content.ReadAsStringAsync(ct);
                HttpStatusCode status = resp.StatusCode;
                string message = resp.StatusCode switch
                {
                    HttpStatusCode.Conflict => "An evaluation with a duplicate correlation ID has been submitted.",
                    HttpStatusCode.Unauthorized => "Authentication is required and/or has failed.",
                    HttpStatusCode.Forbidden => "The user is not permitted to perform this operation.",
                    HttpStatusCode.InternalServerError => "An internal error has occurred.",
                    _ => "The HTTP status code of the response was not expected",
                };

                throw new MalwareServiceClientException(
                    message,
                    (int)resp.StatusCode,
                    response,
                    null);
            }
        }

        /// <summary>Gets an evaluation with a specified ID.</summary>
        /// <param name="id">The ID of the evaluation</param>
        /// <returns>The evaluation</returns>
        /// <exception cref="MalwareServiceClientException">
        /// A server side error occurred.
        /// </exception>
        /// <param name="ct">Cancellation token.</param>
        public async Task<Evaluation> GetAsync(string id, CancellationToken ct)
        {
            var resp = await this.generalPurposeHttpClient.GetAsync(
                $"/eval/{id}",
                ct);

            if (resp.IsSuccessStatusCode)
            {
                // buffer the content so that we can read it multiple times if necessary
                // and throw an exception if its larger than expected
                await resp.Content.LoadIntoBufferAsync(MaxResponseBufferSizeInBytes);

                try
                {
                    var evaluation =
                        await resp.Content.ReadFromJsonAsync<Evaluation>(null, ct);

                    if (evaluation == null)
                    {
                        // get the content as Stream and rewind it
                        Stream stream = await resp.Content.ReadAsStreamAsync(ct);
                        stream.Seek(0, SeekOrigin.Begin);

                        string response = await resp.Content.ReadAsStringAsync(ct);

                        throw new MalwareServiceClientException(
                            "Evaluation is null.",
                            (int)resp.StatusCode,
                            response,
                            null);
                    }

                    return evaluation;
                }
                catch (Exception ex)
                {
                    // get the content as Stream and rewind it
                    Stream stream = await resp.Content.ReadAsStreamAsync(ct);
                    stream.Seek(0, SeekOrigin.Begin);

                    string response = await resp.Content.ReadAsStringAsync(ct);

                    throw new MalwareServiceClientException(
                        "Could not deserialize the response body.",
                        (int)resp.StatusCode,
                        response,
                        ex);
                }
            }
            else
            {
                string response = await resp.Content.ReadAsStringAsync(ct);
                string message = resp.StatusCode switch
                {
                    HttpStatusCode.NotFound => "An evaluation with the specified ID could not be found.",
                    HttpStatusCode.Unauthorized => "Authentication is required and/or has failed.",
                    HttpStatusCode.Forbidden => "The user is not permitted to perform this operation.",
                    HttpStatusCode.InternalServerError => "An internal error has occurred.",
                    _ => "The HTTP status code of the response was not expected",
                };

                throw new MalwareServiceClientException(
                    message,
                    (int)resp.StatusCode,
                    response,
                    null);
            }
        }

        /// <summary>Gets an evaluation file with a specified SHA-256 hash.</summary>
        /// <param name="hash">The SHA-256 hash of the file</param>
        /// <returns>The evaluation file</returns>
        /// <exception cref="MalwareServiceClientException">
        /// A server side error occurred.
        /// </exception>
        /// <param name="ct">Cancellation token.</param>
        public async Task<EvaluationFile> FileBySha256Async(
            string hash,
            CancellationToken ct)
        {
            var resp = await this.generalPurposeHttpClient.GetAsync(
                $"/eval/file/sha256/{hash}",
                ct);

            if (resp.IsSuccessStatusCode)
            {
                // buffer the content so that we can read it multiple times if necessary
                // and throw an exception if its larger than expected
                await resp.Content.LoadIntoBufferAsync(MaxResponseBufferSizeInBytes);

                try
                {
                    var evaluationFile =
                        await resp.Content.ReadFromJsonAsync<EvaluationFile>(null, ct);

                    if (evaluationFile == null)
                    {
                        // get the content as Stream and rewind it
                        Stream stream = await resp.Content.ReadAsStreamAsync(ct);
                        stream.Seek(0, SeekOrigin.Begin);

                        string response = await resp.Content.ReadAsStringAsync(ct);

                        throw new MalwareServiceClientException(
                            "EvaluationFile is null.",
                            (int)resp.StatusCode,
                            response,
                            null);
                    }

                    return evaluationFile;
                }
                catch (Exception ex)
                {
                    // get the content as Stream and rewind it
                    Stream stream = await resp.Content.ReadAsStreamAsync(ct);
                    stream.Seek(0, SeekOrigin.Begin);

                    string response = await resp.Content.ReadAsStringAsync(ct);

                    throw new MalwareServiceClientException(
                        "Could not deserialize the response body.",
                        (int)resp.StatusCode,
                        response,
                        ex);
                }
            }
            else
            {
                string response = await resp.Content.ReadAsStringAsync(ct);
                string message = resp.StatusCode switch
                {
                    HttpStatusCode.NotFound => "An evaluation file with the specified SHA-256 hash could not be found.",
                    HttpStatusCode.Unauthorized => "Authentication is required and/or has failed.",
                    HttpStatusCode.Forbidden => "The user is not permitted to perform this operation.",
                    HttpStatusCode.InternalServerError => "An internal error has occurred.",
                    _ => "The HTTP status code of the response was not expected",
                };

                throw new MalwareServiceClientException(
                    message,
                    (int)resp.StatusCode,
                    response,
                    null);
            }
        }
    }
}
